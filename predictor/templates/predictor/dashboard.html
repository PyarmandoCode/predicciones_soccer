{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‚öΩ Dashboard de Pron√≥sticos | PyArmando Academy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons/css/flag-icons.min.css">
  <style>
      /* === ESTILO GENERAL === */
    body {
      background: radial-gradient(circle at top left, #001f3f, #0a0a23);
      background-size: 400% 400%;
      animation: gradientMove 10s ease infinite;
      font-family: 'Poppins', sans-serif;
      color: #fff;
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* === NAVBAR === */
    .navbar {
      background: linear-gradient(90deg, #4b6cb7, #182848);
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }

    /* === TARJETAS DE ESTAD√çSTICAS === */
    .stat-card {
      border: none;
      border-radius: 15px;
      color: #fff;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-5px); }

    /* === TABLA === */
    .table-container {
      background: #ffffff10;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      transition: all 0.5s ease-in-out;
    }
    .table-hover tbody tr:hover {
      background-color: rgba(255,255,255,0.1);
      transform: scale(1.01);
      transition: all 0.2s ease-in-out;
    }

    /* === COLORES DE RESULTADOS === */
    .prob-fav { background-color: #4caf50 !important; color: #fff !important; }
    .prob-draw { background-color: #ffeb3b !important; color: #000 !important; }
    .prob-away { background-color: #f44336 !important; color: #fff !important; }

    /* === DROPDOWN === */
    .dropdown-menu {
      background-color: #001f3f;
      color: #fff;
      border: none;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }
    .dropdown-menu .dropdown-item {
      color: #fff;
    }
    .dropdown-menu .dropdown-item:hover {
      background-color: #004080;
      color: #fff;
    }

    /* === BOT√ìN DROPDOWN === */
    #dropdownLigas {
      transition: border-color 0.3s, color 0.3s, background 0.3s;
    }

    /* === ANIMACI√ìN DE CARGA === */
    .loader {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .loader span {
      display: inline-block;
      width: 12px; height: 12px;
      margin: 0 4px;
      background: #fff;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    .loader span:nth-child(1) { animation-delay: -0.32s; }
    .loader span:nth-child(2) { animation-delay: -0.16s; }

    /* === FOOTER === */
    .footer {
      margin-top: 40px;
      font-size: 0.9rem;
      color: #111;
      background-color: #001f3f; /* modo oscuro */
      border-top: 1px solid rgba(255,255,255,0.2);
      padding: 15px 0;
      text-align: center;
      transition: all 0.3s;
    }

    /* === MODO CLARO === */
    body.light-mode {
      background: #f8f9fa;
      color: #111;
    }

    /* Navbar claro */
    body.light-mode .navbar {
      background: linear-gradient(90deg, #2b5876, #4e4376);
    }

    /* Cards y tablas */
    body.light-mode .table-container {
      background: #fff;
      color: #000;
    }
    body.light-mode .stat-card {
      color: #000;
    }

    /* Dropdown claro */
    body.light-mode .dropdown-menu {
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    body.light-mode .dropdown-menu .dropdown-item {
      color: #000;
    }
    body.light-mode .dropdown-menu .dropdown-item:hover {
      background-color: #e9ecef;
      color: #000;
    }

    /* Bot√≥n dropdown claro */
    body.light-mode #dropdownLigas {
      border-color: #333;
      color: #111;
      background-color: #fff;
    }
    body.light-mode #dropdownLigas:hover {
      background-color: #f1f1f1;
      color: #111;
      border-color: #333;
    }

    /* Footer claro */
    body.light-mode .footer {
      
      color: #111 !important;
      border-top: 1px solid #ccc;
      padding: 15px 0;
      opacity: 1;
    }

    /* T√≠tulos visibles en claro */
    body.light-mode h2,
    body.light-mode h6,
    body.light-mode h3,
    body.light-mode .navbar-brand {
      color: #000 !important;
    }

</style>

  
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-dark fixed-top px-3">
    <a class="navbar-brand fw-bold text-white" href="#">‚öΩ PyArmando <span class="text-info">Predictions</span></a>
    <div>
      <button id="toggleTheme" class="btn btn-outline-light btn-sm">üåô Modo Oscuro</button>
    </div>
  </nav>
  <div class="mt-5"></div>

  <div class="container py-4">

    <!-- ENCABEZADO -->
    <div class="d-flex justify-content-between align-items-center mb-4 p-3 rounded shadow-sm bg-gradient" 
        style="background: linear-gradient(90deg, #4b6cb7, #182848); color: white;">
      <h2 class="fw-bold mb-0" style="letter-spacing: 1px;">üìä Pron√≥sticos de Partidos</h2>
      <div class="text-light small">
        <i class="bi bi-clock-history me-1"></i> Actualizado: {{ current_time|date:"d/m/Y H:i" }}
      </div>
    </div>

    <!-- TARJETAS DE ESTAD√çSTICAS -->
    <div class="row text-center mb-4">
      <div class="col-md-3">
        <div class="card stat-card bg-success bg-opacity-25 p-3">
          <h6>‚úîÔ∏è Partidos Analizados</h6>
          <h3>{{ total_partidos }}</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card bg-warning bg-opacity-25 p-3">
          <h6>üìÖ Pr√≥ximos 7 D√≠as</h6>
          <h3>{{ rango_fechas }}</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card bg-info bg-opacity-25 p-3">
          <h6>üèÜ Liga Seleccionada</h6>
          <h3 id="ligaActiva">Ninguna</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stat-card bg-danger bg-opacity-25 p-3">
          <h6>üìä Precisi√≥n AI</h6>
          <h3>92%</h3>
        </div>
      </div>
    </div>

    <!-- SELECTOR DE LIGA Y BOT√ìN -->
    <div class="input-group mb-3 d-flex align-items-center">
      <div class="dropdown flex-grow-1">
        <button class="btn btn-outline-light dropdown-toggle w-100 d-flex align-items-center justify-content-between"
                type="button" id="dropdownLigas" data-bs-toggle="dropdown" aria-expanded="false">
          <span id="ligaSeleccionada"><i class="fi fi-eu"></i> Selecciona una liga...</span>
        </button>
        <ul class="dropdown-menu w-100" aria-labelledby="dropdownLigas">
          {% for code, info in ligas.items %}
            <li><a class="dropdown-item d-flex align-items-center" href="#" data-liga="{{ code }}">
              <i class="fi fi-{{ info.pais }} me-2"></i> {{ info.nombre }}
            </a></li>
          {% endfor %}
        </ul>
      </div>
      <button id="btnActualizar" class="btn btn-success ms-2 d-flex align-items-center gap-2">üîÑ Actualizar</button>
    </div>

    <input type="hidden" id="ligaSelect" name="liga">
    <div id="mensaje" class="alert d-none"></div>

    <!-- ANIMACI√ìN DE CARGA -->
    <div class="loader" id="loader">
      <span></span><span></span><span></span>
      <p class="mt-2">Actualizando datos...</p>
    </div>

    <!-- TABLA -->
    <div id="tabla-container" class="table-container">
      {% include "predictor/tabla_partidos.html" %}
    </div>

    <!-- FOOTER -->
    <footer class="footer text-center mt-5 py-3 border-top border-light">
      <p class="mb-0 text-light">
        ‚öΩ <strong>PyArmando Academy</strong> ‚Äî Dashboard de Predicci√≥n 
        
      </p>
    </footer>
  </div>

  <!-- TOAST -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toastMensaje" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">‚úÖ Datos actualizados correctamente.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* --- SELECCI√ìN DE LIGA --- */
    document.querySelectorAll('.dropdown-item').forEach(item => {
      item.addEventListener('click', e => {
        e.preventDefault();
        const code = item.getAttribute('data-liga');
        const nombre = item.textContent.trim();
        const bandera = item.querySelector('i').outerHTML;
        document.getElementById('ligaSeleccionada').innerHTML = `${bandera} ${nombre}`;
        document.getElementById('ligaActiva').textContent = nombre;
        document.getElementById('ligaSelect').value = code;
      });
    });

    /* --- ACTUALIZAR DATOS --- */
    document.getElementById('btnActualizar').addEventListener('click', function() {
      const liga = document.getElementById('ligaSelect').value;
      const loader = document.getElementById('loader');
      const mensaje = document.getElementById('mensaje');
      const tabla = document.getElementById('tabla-container');
      const toast = new bootstrap.Toast(document.getElementById('toastMensaje'));

      if (!liga) {
        mensaje.className = 'alert alert-warning';
        mensaje.textContent = '‚ö†Ô∏è Debes seleccionar una liga.';
        mensaje.classList.remove('d-none');
        return;
      }

      mensaje.classList.add('d-none');
      loader.style.display = 'block';
      tabla.style.opacity = '0.4';

      fetch("{% url 'actualizar_liga' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'liga=' + liga
      })
      .then(response => response.json())
      .then(data => {
          loader.style.display = 'none';
          tabla.style.opacity = '1';
          if (data.success) {
            tabla.innerHTML = data.html;
            toast.show();

            // üî• Actualizar contador de partidos analizados
            const contador = document.querySelector('.stat-card.bg-success h3');
            if (contador && data.total_partidos !== undefined) {
              contador.textContent = data.total_partidos;
            }

          } else {
            mensaje.className = 'alert alert-danger';
            mensaje.textContent = data.error || '‚ùå Error al actualizar.';
            mensaje.classList.remove('d-none');
          }
        })

      .catch(() => {
        loader.style.display = 'none';
        tabla.style.opacity = '1';
        mensaje.className = 'alert alert-danger';
        mensaje.textContent = '‚ùå Error al conectar con el servidor.';
        mensaje.classList.remove('d-none');
      });
    });

    /* --- MODO OSCURO / CLARO --- */
    document.getElementById("toggleTheme").addEventListener("click", () => {
      document.body.classList.toggle("light-mode");
      const btn = document.getElementById("toggleTheme");
      btn.textContent = document.body.classList.contains("light-mode") ? "üåû Modo Claro" : "üåô Modo Oscuro";
    });
  </script>
</body>
</html>
